tc qdisc del dev {{interfaces.egress}} root 2>/dev/null || true
tc qdisc add dev {{interfaces.egress}} root handle 1: htb default 0

tc qdisc del dev {{interfaces.ingress}} root 2>/dev/null || true
tc qdisc add dev {{interfaces.ingress}} root handle 1: htb default 0

{{#each classes}}
tc class add dev {{@root.interfaces.egress}} parent {{parent}} classid {{id}} htb rate {{bandwidth.upload}}mbit ceil {{bandwidth.upload}}mbit
tc qdisc add dev {{@root.interfaces.egress}} parent {{id}} netem delay {{round_trip_time}}ms {{round_trip_time_correlation}}ms distribution normal loss 1% 25%
tc class add dev {{@root.interfaces.ingress}} parent {{parent}} classid {{id}} htb rate {{bandwidth.download}}mbit ceil {{bandwidth.download}}mbit
{{/each}}

{{#each filters}}
tc filter add dev {{@root.interfaces.egress}} protocol ip parent 1: handle {{fwmark}} fw classid {{classID}}
tc filter add dev {{@root.interfaces.ingress}} protocol ip parent 1: handle {{fwmark}} fw classid {{classID}}
{{/each}}
